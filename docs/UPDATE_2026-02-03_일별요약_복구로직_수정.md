# ComputerOff 시스템 버그 수정 (2026-02-03)

## 수정된 문제

### 1. 관리자 페이지 일별 요약 표시 안됨

**문제**: 첫 시작/마지막 종료 시간이 표시되지 않음

**원인**: SQLite의 `DATE()`, `TIME()` 함수가 ISO 형식 타임스탬프(예: `2024-01-15T18:30:45.123456`)를 일관성 없게 처리

**해결**: `strftime()` 함수를 사용하여 ISO 형식 문자열을 명시적으로 파싱

**수정 파일**: `server/database.py`
- `get_daily_summary()` 함수 (701-726행)
- `get_computer_daily_summary()` 함수 (729-750행)

**변경 내용**:
```sql
-- 기존
DATE(timestamp) as date
TIME(timestamp)

-- 수정 후
strftime('%Y-%m-%d', timestamp) as date
strftime('%H:%M:%S', timestamp)
```

---

### 2. 이벤트 로그 폴백 복구 미작동

**문제**: 종료 이벤트 미수집 시 Windows 이벤트 로그에서 복구하는 기능이 작동하지 않음

**원인**:
1. `record_id` 비교 로직이 이벤트 로그 리셋을 고려하지 않음
2. `timestamp` 비교 시 경계 조건(`<=`)으로 인해 유효한 이벤트 누락
3. 상태 파일 손상 시 복구 기준 상실

**수정 파일**: `agent/installer.py`
- `parse_event_xml()` 함수 (354행) - 경계 조건 수정
- `recover_missed_shutdown_events()` 함수 (582-599행) - record_id 비교 로직 개선
- `recover_missed_shutdown_events()` 함수 (555-560행) - 상태 파일 복원력 강화

**변경 내용**:

#### 2-1. 경계 조건 수정
```python
# 기존: timestamp_kst <= since_timestamp
# 수정: timestamp_kst < since_timestamp - timedelta(seconds=1)
```
1초 여유를 두어 밀리초 단위 차이로 인한 이벤트 누락 방지

#### 2-2. record_id 비교 로직 개선
```python
# 기존: 단순 record_id 비교만 수행
if event['record_id'] <= last_record_id:
    continue

# 수정: timestamp로 이중 검증하여 이벤트 로그 리셋 감지
if last_record_id is not None and last_record_id > 0:
    if event['record_id'] <= last_record_id:
        if event['timestamp'] <= last_sent:
            # 진짜 중복 - 건너뜀
            continue
        else:
            # 이벤트 로그 리셋 감지 - 복구 진행
```

#### 2-3. 상태 파일 복원력 강화
```python
# 로컬 상태가 없고 서버만 있는 경우 동기화
elif last_sent_on_server:
    last_sent = last_sent_on_server
    state['last_sent_shutdown'] = last_sent_on_server.isoformat()
    save_state(state)
```

---

## 검증 방법

### Issue 1 검증 (일별 요약)
```bash
# 서버 API 테스트
curl http://localhost:8000/api/daily-summary?days=7

# 응답에서 first_boot, last_shutdown 값 확인
```

### Issue 2 검증 (이벤트 복구)
```bash
# Agent 로그 확인 (Windows)
type %LOCALAPPDATA%\ComputerOff\logs\computeroff.log

# 복구 로그 예시:
# recover_missed_shutdown_events 시작
# 서버의 마지막 shutdown 시간: 2026-02-03 18:30:45
# 이벤트 로그에서 조회된 종료 이벤트: 2개
# 미전송 종료 이벤트 복구 시도: normal at 2026-02-03 19:00:00
# 복구 전송 성공: record_id=12345
```

---

## 영향 범위

- **32비트/64비트**: 양쪽 모두 지원 (Python 코드 수정이므로 아키텍처 독립적)
- **서버**: 재시작 필요 (database.py 변경)
- **Agent**: 다음 부팅 시 자동 적용 (installer.py 변경)
